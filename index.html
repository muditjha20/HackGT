<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Situation 3 â€” Web & WebXR (Pixel-Perfect)</title>

  <!-- A-Frame for WebXR -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- html2canvas to snapshot the DOM UI -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root {
      --bg:#0f1115; --panel:#171a21; --text:#e7e9ee; --muted:#9aa3b2;
      --good:#46d28a; --bad:#ff6b6b; --warn:#f5c451; --card:#13161c; --border:#222736;
      --radius:14px; --shadow:0 8px 28px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:radial-gradient(1200px 600px at 20% -10%,#182035 0%,#0f1115 60%);
      color:var(--text); font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      min-height:100svh; display:grid; place-items:center; padding:24px;
    }
    .app{
      width:100%; max-width:920px; background:linear-gradient(180deg,#151a25,#11141a);
      border:1px solid var(--border); border-radius:22px; box-shadow:var(--shadow);
      padding:22px; display:grid; gap:18px; position:relative; z-index:2;  /* stays above scene on desktop */
    }
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 2px 2px}
    .title{font-weight:600; letter-spacing:.3px} .meta{color:var(--muted); font-size:13px}
    .stage{display:grid; grid-template-columns:1.2fr .8fr; gap:18px}
    @media (max-width:860px){.stage{grid-template-columns:1fr}}
    .panel{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius);
      padding:16px; display:grid; gap:12px; min-height:260px}
    .npc{display:grid; grid-template-columns:60px 1fr auto; gap:12px; align-items:center;
      background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px 12px}
    .avatar{width:60px; height:60px; border-radius:50%; display:grid; place-items:center; font-size:28px;
      user-select:none; border:1px solid var(--border); background:#12161e}
    .npc-lines{display:grid; gap:4px} .npc-name{font-weight:700; font-size:14px}
    .npc-feel.tag{padding:6px 10px; border-radius:8px; font-weight:700; font-size:12px; border:1px solid var(--border); white-space:nowrap}
    .ok{color:var(--good); background:rgba(70,210,138,.08); border-color:rgba(70,210,138,.25)}
    .bad{color:var(--bad); background:rgba(255,107,107,.08); border-color:rgba(255,107,107,.25)}
    .warn{color:var(--warn); background:rgba(245,196,81,.08); border-color:rgba(245,196,81,.25)}
    .muted{color:var(--muted)}
    .log{display:grid; gap:10px; max-height:44vh; overflow:auto; scrollbar-width:thin; padding-right:4px}
    .line{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px 12px; display:grid; gap:6px}
    .who{font-weight:600; font-size:13px; color:var(--muted)} .text{font-size:15px}
    .chiprow{display:flex; flex-wrap:wrap; gap:8px}
    .chip{border:1px solid var(--border); background:#12161e; color:var(--text);
      border-radius:999px; padding:10px 14px; cursor:pointer; user-select:none;
      transition:transform .04s ease, border-color .2s ease, background .2s ease;
      font-weight:600; font-size:14px; letter-spacing:.2px}
    .chip:hover{transform:translateY(-1px); border-color:#2a3145}
    .chip.yell{background:#1b1416; border-color:#3a2026}
    .chip.separate{background:#0f1914; border-color:#1f3a2d}
    .chip.ignore{background:#1a170e; border-color:#3a2f14}
    .status{display:grid; gap:10px}
    .tag{display:inline-block; padding:6px 10px; border-radius:8px; font-weight:700; font-size:12px; border:1px solid var(--border)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .footer{display:flex; align-items:center; justify-content:space-between; color:var(--muted);
      border-top:1px dashed #232a3c; padding-top:10px; margin-top:4px}
    button.reset{border:1px solid var(--border); background:#121722; color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600}
    button.reset:hover{border-color:#2a3145}

    /* A-Frame canvas sits behind on desktop; in VR it fills screen */
    a-scene{position:fixed; inset:0; z-index:1}

    /* Hidden canvas that holds the UI snapshot used as VR texture */
    #uiCanvas{display:none}
  </style>
</head>
<body>
  <!-- WebXR scene -->
  <a-scene renderer="antialias: true; colorManagement: true" vr-mode-ui="enabled: true">
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 0.6" position="1 2 1"></a-entity>
    <a-sky color="#0a0f1a"></a-sky>

    <!-- Camera + cursor -->
    <a-entity id="cameraRig" position="0 1.6 0">
      <a-entity camera look-controls>
        <a-cursor fuse="true" fuse-timeout="700"
          material="shader: flat"
          geometry="primitive: ring; radiusInner: 0.005; radiusOuter: 0.01"
          position="0 0 -1"></a-cursor>
      </a-entity>
    </a-entity>

    <!-- Component: always face camera -->
    <script>
      AFRAME.registerComponent('face-camera', {
        tick: function(){
          const cam=this.el.sceneEl.camera; if(!cam) return;
          const v=cam.el.object3D.getWorldPosition(new THREE.Vector3());
          this.el.object3D.lookAt(v);
        }
      });
    </script>

    <!-- Plane that shows a live texture of the real web UI -->
    <a-entity id="uiBoard" position="0 1.4 -1.8" face-camera>
      <!-- geometry set from JS to match aspect -->
      <a-plane id="uiPlane" material="src: #uiCanvas; transparent: true"></a-plane>

      <!-- Invisible hotzones aligned with the three web buttons -->
      <a-plane id="hotYell"    opacity="0" color="#fff"></a-plane>
      <a-plane id="hotSeparate"opacity="0" color="#fff"></a-plane>
      <a-plane id="hotIgnore"  opacity="0" color="#fff"></a-plane>
    </a-entity>
  </a-scene>

  <!-- 2D App (the source of truth UI) -->
  <div class="app" id="app">
    <header>
      <div>
        <div class="title">Teacher De-escalation â€” Situation 3</div>
        <div class="meta">Elementary school at a local history museum</div>
      </div>
      <button class="reset" id="resetBtn" aria-label="Restart scenario">Restart</button>
    </header>

    <div class="stage">
      <section class="panel" aria-live="polite">
        <div class="npc" id="npcCard">
          <div class="avatar" id="npcAvatar" aria-hidden="true">ðŸ˜Ÿ</div>
          <div class="npc-lines">
            <div class="npc-name">Student A (frustrated)</div>
            <div class="npc-line" id="npcLine">"It's not fair! I missed the dinosaur exhibit."</div>
            <div class="muted" id="npcAside">Waiting for your responseâ€¦</div>
          </div>
          <div class="npc-feel tag warn" id="npcFeel">Agitated</div>
        </div>
        <div class="log" id="log"></div>
        <div class="footer">
          <span class="muted" id="hint">Choose a teacher response to see what happens.</span>
          <div class="row" id="stateTags"></div>
        </div>
      </section>

      <aside class="panel">
        <div style="font-weight:700">Your options</div>
        <div class="chiprow" id="btnRow">
          <div class="chip yell"     data-action="yell"     id="btnYell">Yell at the frustrated student</div>
          <div class="chip separate" data-action="separate" id="btnSeparate">Separate the student from the class</div>
          <div class="chip ignore"   data-action="ignore"   id="btnIgnore">Ignore the situation</div>
        </div>
        <div class="status" id="status"></div>
      </aside>
    </div>
  </div>

  <!-- Offscreen canvas used as WebXR texture -->
  <canvas id="uiCanvas"></canvas>

  <script>
    /* ------------------------- DATA ------------------------- */
    const initialTranscript = [
      { who: "Student A (frustrated)", text: "It's not fair! Everyone else got to see the dinosaur exhibit, and I didn't!" },
      { who: "Student B (teasing)",     text: "Maybe you were too slow! You always miss stuff." },
      { who: "Student A",               text: "Stop it! I didn't miss it on purpose!" },
      { who: "Student C (joining in)",  text: "Yeah, maybe if you paid attention for once!" }
    ];
    const outcomes = {
      yell: {
        teacher: "Ok, that's enough! You need to stop shouting and behave right now! We have a tour to get through.",
        aftermath: [
          { who: "Student A (reacts)", text: "That's not fair! You're not listening!" },
          { who: "Narration", text: "After being yelled at, Student A becomes even more frustrated and starts lashing out at others and back at you." }
        ],
        tags: [{ cls: "bad", text: "Escalation" }, { cls: "", text: "Emotional safety â†“" }],
        status: { text: "Outcome: Escalation (not recommended in this context)", kind: "bad" },
        npc: { emoji:"ðŸ˜ ", feelClass:"bad", feelText:"Upset", line:"\"Please stop yellingâ€¦\"", aside:"Heart rate â†‘, fight/flight" }
      },
      separate: {
        teacher: "Alright, let's step aside for a moment to talk. That sounds so frustratingâ€”let's make sure you don't miss out again.",
        aftermath: [
          { who: "Student A (reacts)", text: "â€¦Okay. Can I still see the dinosaur later?" },
          { who: "Narration", text: "Away from the crowd, Student A feels safer and opens up. The class teasing subsides while you plan a quick path so they don't miss the next exhibit." }
        ],
        tags: [{ cls: "ok", text: "De-escalation" }, { cls: "", text: "Emotional safety â†‘" }],
        status: { text: "Outcome: De-escalation (recommended)", kind: "ok" },
        npc: { emoji:"ðŸ™‚", feelClass:"ok", feelText:"Calmer", line:"\"Thanks for helping me catch up.\"", aside:"Breathing steadies" }
      },
      ignore: {
        teacher: "(You choose to ignore the situation.)",
        aftermath: [
          { who: "Student A (reacts)", text: "Why is nobody helping me?!" },
          { who: "Narration", text: "Without intervention, teasing continues. Some students shove; Student A becomes more agitated and lashes out." }
        ],
        tags: [{ cls: "warn", text: "Avoidance" }, { cls: "bad", text: "Harm risk â†‘" }],
        status: { text: "Outcome: Avoidance leading to escalation (not recommended)", kind: "bad" },
        npc: { emoji:"ðŸ˜¢", feelClass:"warn", feelText:"Distressed", line:"\"This is getting worseâ€¦\"", aside:"Feels unsafe" }
      }
    };

    /* ------------------------- DOM REFS ------------------------- */
    const appEl = document.getElementById('app');
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const hintEl = document.getElementById('hint');
    const tagsEl = document.getElementById('stateTags');
    const resetBtn = document.getElementById('resetBtn');

    const npcAvatar = document.getElementById('npcAvatar');
    const npcLine = document.getElementById('npcLine');
    const npcAside = document.getElementById('npcAside');
    const npcFeel = document.getElementById('npcFeel');

    const uiCanvas = document.getElementById('uiCanvas');
    const uiPlane  = document.getElementById('uiPlane');
    const uiBoard  = document.getElementById('uiBoard');

    const btnYell = document.getElementById('btnYell');
    const btnSep  = document.getElementById('btnSeparate');
    const btnIgn  = document.getElementById('btnIgnore');

    const hotYell = document.getElementById('hotYell');
    const hotSeparate = document.getElementById('hotSeparate');
    const hotIgnore = document.getElementById('hotIgnore');

    /* ------------------------- HELPERS ------------------------- */
    function clear(el){ el.innerHTML = ''; }

    function addLine({who, text}){
      const div=document.createElement('div'); div.className='line';
      const w=document.createElement('div'); w.className='who'; w.textContent=who;
      const t=document.createElement('div'); t.className='text'; t.textContent=text;
      div.appendChild(w); div.appendChild(t);
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
      snapshotToVR(); // keep VR identical
    }

    function setTags(list){
      clear(tagsEl);
      list.forEach(({cls,text})=>{
        const span=document.createElement('span');
        span.className = `tag ${cls}`;
        span.textContent = text;
        tagsEl.appendChild(span);
      });
      snapshotToVR();
    }

    function setStatus(text, kind=''){
      statusEl.innerHTML = `<div class="tag ${kind}">${text}</div>`;
      snapshotToVR();
    }

    function updateNPC({emoji, feelClass, feelText, line, aside}){
      npcAvatar.textContent = emoji;
      npcFeel.className = `npc-feel tag ${feelClass}`;
      npcFeel.textContent = feelText;
      npcLine.textContent = line;
      npcAside.textContent = aside;
      snapshotToVR();
    }

    function renderInitial(){
      clear(logEl); clear(statusEl); setTags([]);
      npcAvatar.textContent = "ðŸ˜Ÿ";
      npcFeel.className = "npc-feel tag warn";
      npcFeel.textContent = "Agitated";
      npcLine.textContent = `"It's not fair! I missed the dinosaur exhibit."`;
      npcAside.textContent = "Waiting for your responseâ€¦";
      initialTranscript.forEach(addLine);
      hintEl.textContent = "Choose a teacher response to see what happens.";
      snapshotToVR(true);
    }

    function play(actionKey){
      const action = outcomes[actionKey]; if(!action) return;
      addLine({ who: "Teacher", text: action.teacher });
      action.aftermath.forEach(addLine);
      setTags(action.tags);
      hintEl.textContent = "Outcome shown. Use Restart to try another path.";
      setStatus(action.status.text, action.status.kind);
      updateNPC(action.npc);
    }

    // Wire web buttons
    document.querySelectorAll('.chip').forEach(chip=>{
      chip.addEventListener('click', ()=>play(chip.dataset.action));
    });
    resetBtn.addEventListener('click', renderInitial);

    /* ------------------ VR SNAPSHOT & HOTZONES ------------------ */
    let lastW=0, lastH=0;

    async function snapshotToVR(init=false){
      // Size the offscreen canvas to the current UI size at 2x for clarity
      const scale = 2;
      const rect = appEl.getBoundingClientRect();
      const w = Math.max(1, Math.round(rect.width  * scale));
      const h = Math.max(1, Math.round(rect.height * scale));

      if (uiCanvas.width !== w || uiCanvas.height !== h) {
        uiCanvas.width = w; uiCanvas.height = h;
      }

      // Render DOM -> canvas
      const snap = await html2canvas(appEl, {
        backgroundColor: null,
        scale, width: rect.width, height: rect.height,
        x: 0, y: 0, windowWidth: document.documentElement.clientWidth,
      });

      // Draw snapshot into our persistent canvas (texture source)
      const ctx = uiCanvas.getContext('2d');
      ctx.clearRect(0,0,w,h);
      ctx.drawImage(snap, 0, 0, w, h);

      // Update plane geometry to match aspect
      if (init || w !== lastW || h !== lastH) {
        lastW = w; lastH = h;
        const planeWidthMeters = 1.8; // desired width in VR
        const planeHeightMeters = planeWidthMeters * (h/w);
        uiPlane.setAttribute('geometry', `primitive: plane; width: ${planeWidthMeters}; height: ${planeHeightMeters}`);
        positionHotzones(planeWidthMeters, planeHeightMeters);
      }
      // Force material refresh (some browsers cache)
      const mat = uiPlane.getObject3D('mesh');
      if (mat && mat.material && mat.material.map) { mat.material.map.needsUpdate = true; }
    }

    // Place three invisible planes over the button row so VR clicks work
    function positionHotzones(planeW, planeH){
      // Compute positions relative to the bottom area of the plane.
      // We read DOM button rectangles and map into plane coordinates.
      const appRect = appEl.getBoundingClientRect();
      const rowRect = document.getElementById('btnRow').getBoundingClientRect();

      const btnRects = [
        document.getElementById('btnYell').getBoundingClientRect(),
        document.getElementById('btnSeparate').getBoundingClientRect(),
        document.getElementById('btnIgnore').getBoundingClientRect()
      ];
      const hotPlanes = [hotYell, hotSeparate, hotIgnore];

      btnRects.forEach((r, i) => {
        const cx = ( (r.left + r.right)/2 - appRect.left ) / appRect.width;   // 0..1 across app
        const cy = ( (r.top  + r.bottom)/2 - appRect.top  ) / appRect.height;  // 0..1 down app
        const bw = (r.width  / appRect.width)  * planeW;
        const bh = (r.height / appRect.height) * planeH;

        // Map (0..1) to plane coords: center (0,0), x in [-W/2, W/2], y in [-H/2, H/2]
        const x = (cx - 0.5) * planeW;
        const y = (0.5 - cy) * planeH;

        hotPlanes[i].setAttribute('geometry', `primitive: plane; width: ${bw}; height: ${bh}`);
        hotPlanes[i].setAttribute('position', {x, y, z: 0.01});
      });

      // Attach actions once
      if (!hotYell.dataset.wired) {
        hotYell.addEventListener('click',    ()=>play('yell'));
        hotSeparate.addEventListener('click',()=>play('separate'));
        hotIgnore.addEventListener('click',  ()=>play('ignore'));
        hotYell.dataset.wired = "1";
      }
    }

    // Re-snapshot on resize (keeps VR identical if window size changes)
    window.addEventListener('resize', ()=>snapshotToVR(true));

    // Re-snapshot when entering/exiting VR (also hide/show desktop UI in-headset)
    const scene = document.querySelector('a-scene');
    scene.addEventListener('enter-vr', ()=>{ snapshotToVR(true); });
    scene.addEventListener('exit-vr',  ()=>{ snapshotToVR(true); });

    /* ------------------------- BOOT ------------------------- */
    renderInitial();
  </script>
</body>
</html>
